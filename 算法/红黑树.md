# 红黑树

## 红黑树的性质

1. 每个节点要么是红色，要么是黑色
2. 根节点是黑色
3. 每个叶子节点(NULL)是黑色
4. 每个红色节点的两个子节点是黑色
5. 任何一个节点到每个叶子节点的路径都包含数量相同的黑色节点

如果某节点存在一个黑色子节点那么该该节点肯定有两个子节点
![](image/blackred.svg)

> 关于第五点，通过图片中可以看出，以根节点为例，从根节点到任意的 NIL 节点，黑色的个数是一样的，都是 3。同样选择任意节点到 NIL 节点的黑色节点数也是一致的（虽然不同节点到 NIL 节点路径上的黑色个数不一样）

红黑树并不是一个完美平衡二叉查找树，从图 1 可以看到，根结点 P 的左子树显然比右子树高，但左子树和右子树的黑结点的层数是相等的，也即任意一个结点到到每个叶子结点的路径都包含数量相同的黑结点(性质 5)。所以我们叫红黑树这种`平衡为黑色完美平衡`。

## 红黑树的自平衡

红黑树主要通过以下几种操作来达到自平衡的目的

- 左旋:以某个结点作为支点(旋转结点)，其右子结点变为旋转结点的父结点，右子结点的左子结点变为旋转结点的右子结点，左子结点保持不变。
- 右旋：以某个结点作为支点(旋转结点)，其左子结点变为旋转结点的父结点，左子结点的右子结点变为旋转结点的左子结点，右子结点保持不变。如图 4。
- 变色： 结点的颜色由红变黑或由黑变红。

![图3](https://upload-images.jianshu.io/upload_images/2392382-a95db442f1b47f8a.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

![图4](https://upload-images.jianshu.io/upload_images/2392382-0676a8e2a12e2a0b.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

左旋跟右旋看起来很复杂，但是如果考虑成旋转会更好理解一些。
左旋其实是逆时针旋转树，以上图为例，以 P 点进行左旋，可以看成将 P 点作为根节点，将树逆时针旋转，然后以 V 点作为新的根节点，并且将 V 节点的左子树，挂到 P 点上，作为 P 点的右子树，其他子树保持不变。
右旋类似，还是以 P 点为例，将以 P 点为根的树顺时针旋转，以 F 作为新的根节点，再将 F 的右子树挂到 P 点上，作为 P 点的左子树，其他子树保持不变。

## 红黑树查找

红黑树的查找跟二叉树查找类似，

1. 以根节点为当前节点开始进行查找，如果根节点为 NULL，则直接返回空
2. 比较当前节点的 key，如果 key 大于当前节点，则将左子节点作为新的节点，如果 key 小于当前节点，则将右子节点作为新的节点，如果 key 等于当前节点，则查找结束。

## 红黑树的插入

插入操作包括两部分工作：一查找插入的位置；二插入后自平衡。查找插入的父结点很简单，跟查找操作区别不大：

1. 从根结点开始查找；
2. 若根结点为空，那么插入结点作为根结点，结束。
3. 若根结点不为空，那么把根结点作为当前结点；
4. 若当前结点为 null，返回当前结点的父结点，结束。
5. 若当前结点 key 等于查找 key，那么该 key 所在结点就是插入结点，更新结点的值，结束。
6. 若当前结点 key 大于查找 key，把当前结点的左子结点设置为当前结点，重复步骤 4；
7. 若当前结点 key 小于查找 key，把当前结点的右子结点设置为当前结点，重复步骤 4；

### 插入情景 1：红黑树为空树

最简单的一种情景，直接把插入结点作为根结点就行，但注意，根据红黑树性质 2：根节点是黑色。还需要把插入结点设为黑色。

处理：把插入结点作为根结点，并把结点设置为黑色。

### 插入情景 2：插入结点的 Key 已存在

插入结点的 Key 已存在，既然红黑树总保持平衡，在插入前红黑树已经是平衡的，那么把插入结点设置为将要替代结点的颜色，再把结点的值更新就完成插入。

处理：
把 I 设为当前结点的颜色
更新当前结点的值为插入结点的值

### 插入情景 3：插入结点的父结点为黑结点

由于插入的结点是红色的，并不会影响红黑树的平衡，直接插入即可，无需做自平衡。

处理：直接插入。

### 插入情景 4：插入结点的父结点为红结点

再次回想下红黑树的性质 2：根结点是黑色。如果插入的父结点为红结点，那么该父结点不可能为根结点，所以插入结点总是存在祖父结点。这点很重要，因为后续的旋转操作肯定需要祖父结点的参与。

#### 4.1 叔叔节点存在并且为红色

**只需要改变节点的颜色**

处理：

将 P 和 S 设置为黑色
将 PP 设置为红色
把 PP 设置为当前插入结点

![](https://upload-images.jianshu.io/upload_images/2392382-9f2c746bf0769f49.png?imageMogr2/auto-orient/strip|imageView2/2/w/656/format/webp)
![](https://upload-images.jianshu.io/upload_images/2392382-5374ea3c2956b441.png?imageMogr2/auto-orient/strip|imageView2/2/w/666/format/webp)

#### 插入情景 4.2：叔叔结点`不存在`或为`黑结点`，并且插入结点的父亲结点是祖父结点的左子结点

需要基于插入节点进行右旋，并且改变旋转之后的颜色，
![](https://upload-images.jianshu.io/upload_images/2392382-ab4097b750826870.png?imageMogr2/auto-orient/strip|imageView2/2/w/670/format/webp)

- 插入情景 4.2.2：插入结点是其父结点的右子结点
  ![](https://upload-images.jianshu.io/upload_images/2392382-fbfc4f299941cb8b.png?imageMogr2/auto-orient/strip|imageView2/2/w/1024/format/webp)

#### 插入情景 4.3：叔叔结点不存在或为黑结点，并且插入结点的父亲结点是祖父结点的右子结点

![](https://upload-images.jianshu.io/upload_images/2392382-2bc24a78b68dae51.png?imageMogr2/auto-orient/strip|imageView2/2/w/622/format/webp)

- 插入情景 4.3.2：插入结点是其父结点的左子结点
  ![](https://upload-images.jianshu.io/upload_images/2392382-ee1a9027ddcc210a.png?imageMogr2/auto-orient/strip|imageView2/2/w/1016/format/webp)
